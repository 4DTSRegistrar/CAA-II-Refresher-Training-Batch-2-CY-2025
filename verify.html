<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Certificate Verification - 4DTS</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background: #f9f9f9; }
    .card { max-width: 900px; margin: auto; padding: 20px; border-radius: 12px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h2 { color: #2c3e50; }
    .label { font-weight: bold; }
    .not-found { color: red; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #3498db; color: white; text-align: left; }
    tr:nth-child(even) { background: #f2f2f2; }
    a.button { display: inline-block; padding: 8px 12px; background: #3498db; color: white; text-decoration: none; border-radius: 6px; }
    a.button:hover { background: #2980b9; }
    .small { font-size: 13px; color: #666; margin-top: 8px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>
  <div class="card">
    <h2>Certificate Verification</h2>
    <div id="result">Loading...</div>
    <div class="small">If nothing shows, check the Batch ID in the QR (must match batch_id in certificates.csv).</div>
  </div>

  <script>
    async function loadCertificates() {
      const params = new URLSearchParams(window.location.search);
      const batchId = params.get("id");

      if (!batchId) {
        document.getElementById("result").innerHTML = "<p class='not-found'>No Batch ID provided.</p>";
        return;
      }

      try {
        const res = await fetch("certificates.csv");
        const csvText = await res.text();

        const parsed = Papa.parse(csvText, {header: true, skipEmptyLines: true});
        const entries = parsed.data;

        const certs = entries.filter(e => (e.batch_id || "").trim() === batchId.trim());

        if (certs.length > 0) {
          let html = `<p><span class="label">Batch ID:</span> ${batchId}</p>`;
          html += `<table><tr><th>#</th><th>Name</th><th>Course</th><th>Date</th></tr>`;
          certs.forEach((row, idx) => {
            html += `<tr>
              <td>${idx+1}</td>
              <td>${row.name || ""}</td>
              <td>${row.course || ""}</td>
              <td>${row.date || ""}</td>
            </tr>`;
          });
          html += `</table>`;

          // Link to batch PDF
          const pdfFile = `certificates/${batchId}.pdf`;
          html += `<p><a class="button" href="${pdfFile}" target="_blank">View Full Batch Certificates (PDF)</a></p>`;

          document.getElementById("result").innerHTML = html;
        } else {
          document.getElementById("result").innerHTML = "<p class='not-found'>No certificates found for this Batch ID.</p>";
        }
      } catch (err) {
        document.getElementById("result").innerHTML = "<p class='not-found'>Error loading certificates.csv</p>";
        console.error(err);
      }
    }

    loadCertificates();
  </script>
</body>
</html>
